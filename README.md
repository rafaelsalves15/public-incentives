# üáµüáπ Sistema de Incentivos P√∫blicos - Portugal

[![Python](https://img.shields.io/badge/Python-3.11-blue.svg)](https://www.python.org/)
[![FastAPI](https://img.shields.io/badge/FastAPI-0.104-green.svg)](https://fastapi.tiangolo.com/)
[![PostgreSQL](https://img.shields.io/badge/PostgreSQL-15-blue.svg)](https://www.postgresql.org/)
[![OpenAI](https://img.shields.io/badge/OpenAI-GPT--4o--mini-orange.svg)](https://openai.com/)
[![Docker](https://img.shields.io/badge/Docker-Compose-2496ED.svg)](https://www.docker.com/)

> **Sistema inteligente de matching entre incentivos p√∫blicos portugueses e empresas**, usando IA h√≠brida (determin√≠stica + LLM) para processar, estruturar e recomendar os incentivos mais adequados para cada empresa.

---

## üìã √çndice

- [üéØ Sobre o Projeto](#-sobre-o-projeto)
- [üèóÔ∏è Arquitetura e Tecnologias](#Ô∏è-arquitetura-e-tecnologias)
- [‚ö° Quick Start](#-quick-start)
- [üöÄ FASE 0: Bootstrap](#-fase-0-bootstrap)
- [üóÑÔ∏è FASE 1: Base de Dados](#Ô∏è-fase-1-base-de-dados)
- [üéØ FASE 2: Sistema de Matching](#-fase-2-sistema-de-matching-inteligente)
- [ü§ñ FASE 3: Chatbot de Incentivos](#-fase-3-chatbot-de-incentivos)
- [üß™ Testes](#-testes)
  
---

## üéØ Sobre o Projeto

Este sistema resolve o problema de **matching entre incentivos p√∫blicos portugueses e empresas** atrav√©s de um pipeline inteligente que:

1. **Importa e estrutura** dados heterog√©neos de incentivos 
2. **Processa com modelo h√≠brido (determin√≠stico e IA)** para completar campos em falta e estruturar informa√ß√£o
3. **Faz matching inteligente** entre incentivos e empresas baseado em m√∫ltiplos crit√©rios
4. **Fornece chatbot** para responder quest√µes sobre incentivos



---

## üèóÔ∏è Arquitetura e Tecnologias

### **Stack Tecnol√≥gico**

| Camada | Tecnologia | Prop√≥sito |
|--------|------------|-----------|
| **Backend** | FastAPI + Python 3.11 | API REST ass√≠ncrona e eficiente |
| **Base de Dados** | PostgreSQL 15 | Armazenamento relacional com suporte JSON |
| **Base de Dados Vetorial** | ChromaDB | Busca sem√¢ntica com embeddings |
| **ORM** | SQLAlchemy 2.0 | Gest√£o de modelos e queries |
| **Migra√ß√µes** | Alembic | Versionamento de schema |
| **IA/LLM** | OpenAI GPT-4o-mini | Processamento inteligente (custo-eficiente) |
| **Embeddings** | text-embedding-3-small | Vetoriza√ß√£o sem√¢ntica (OpenAI) |
| **Containeriza√ß√£o** | Docker + Docker Compose | Ambiente reproduz√≠vel |
| **Data Processing** | Pandas | Manipula√ß√£o de CSVs e transforma√ß√µes |
| **Interface Web** | HTML/CSS/JavaScript | Chatbot web integrado |


---

## ‚ö° Quick Start

### **Pr√©-requisitos**
- Docker & Docker Compose
- OpenAI API Key

### **üöÄ Setup Completo para Avaliador (Recomendado)**

Para um setup completo do sistema com dados realistas:

```bash
# 1. Configurar API Key
echo "OPENAI_API_KEY=sk-your-key-here" >> .env

# 2. Setup padr√£o: 20 incentivos + 1000 empresas (~25-35 min)
make setup-evaluator

# 3. Acessar interface web
# http://localhost:8000/web/
```

**O que faz:**
- Importa e processa 20 incentivos com infer√™ncia de dados por AI
- Cria 1000 empresas simuladas com dados completos
- Gera matches para todos os incentivos
- Inicia chatbot com interface web

**Alternativas:**
```bash
# Setup r√°pido: 10 incentivos + 100 empresas (~3-5 min)
make setup-evaluator-quick

# Setup customizado
make setup-evaluator-custom NUM_INC=30 NUM_COMP=500
```

---



**Comandos √∫teis:**
```bash
# Ver status do sistema
make show-status

# Ver custos de AI
make show-costs

# Ver logs
make logs
```

---

### **üìã Comandos Principais do Sistema**

O sistema inclui comandos abrangentes para todas as fases de desenvolvimento e teste:


```bash
# Ap√≥s setup, acessar interfaces:
# - Chatbot Web: http://localhost:8000/web/
# - API Docs: http://localhost:8000/docs
# - API Chatbot: http://localhost:8000/chatbot/
```

#### **üîß Comandos de Gest√£o**

```bash
# Iniciar/Parar sistema
make up              # Iniciar containers
make down            # Parar containers
make logs            # Ver logs em tempo real

# Acesso a servi√ßos
make db              # Aceder √† base de dados PostgreSQL
make api             # Shell dentro do container API
```



#### **üìä Comandos Auxiliares**

```bash
# Importa√ß√£o de dados
make import-full                  # Dataset completo
make import-sample                # Sample pequeno

# Gest√£o de dados
make clean-db                     # Limpar BD
make show-status                  # Ver status
make show-costs                   # Ver custos
```

---

## üöÄ FASE 0: Bootstrap

### **Setup do Ambiente**

O projeto usa **Docker Compose** para garantir ambiente reproduz√≠vel e isolado.

#### **1. Estrutura de Containers**

```yaml
services:
  db:        # PostgreSQL 15
  api:       # FastAPI + Python 3.11
```

#### **2. Inicializa√ß√£o**

   ```bash
# Subir containers
docker compose up -d

# Aplicar migra√ß√µes de BD
docker compose run --rm api alembic upgrade head

# Verificar status
docker compose ps
```

#### **3. Volumes e Persist√™ncia**

```
./data/              ‚Üí CSVs (montado em /data no container)
./backend/           ‚Üí C√≥digo da API
./infra/docker/      ‚Üí Dockerfiles
```

#### **4. Vari√°veis de Ambiente**

Ficheiro `.env`:
```env
OPENAI_API_KEY=sk-...        # Chave OpenAI (obrigat√≥rio)
DATABASE_URL=postgresql://app:password@db:5432/incentives
```

#### **5. Comandos √öteis**

   ```bash
make up      # Subir containers
make down    # Parar e remover containers
make db      # Aceder √† BD PostgreSQL
make api     # Shell dentro do container API
make logs    # Ver logs em tempo real
```

---

## üóÑÔ∏è FASE 1: Base de Dados

### **Objetivo da Fase**

Criar uma **base de dados estruturada e completa** de incentivos p√∫blicos portugueses, processando CSVs heterog√©neos e usando IA (quando necess√°rio) para:
- ‚úÖ Completar campos em falta (datas, or√ßamentos)
- ‚úÖ Estruturar descri√ß√µes em JSON padronizado


---

### **Arquitetura de 3 Tabelas**

Opt√°mos por uma arquitetura **normalizada em 3 tabelas** para maximizar efici√™ncia e manutenibilidade.

#### **üìã Tabela 1: `incentives` (10 campos) - como pedido no enunciado**

**Prop√≥sito**: Dados principais e frequentemente acedidos.

```sql
CREATE TABLE incentives (
    incentive_id      UUID PRIMARY KEY,
    title             VARCHAR(500) NOT NULL,
    description       TEXT,
    ai_description    JSON,              -- ‚≠ê Estruturado pela AI
    document_urls     JSON,
    publication_date  TIMESTAMP,
    start_date        TIMESTAMP,
    end_date          TIMESTAMP,
    total_budget      NUMERIC,
    source_link       VARCHAR(500),
    cae_primary_code  VARCHAR(50)        -- ‚≠ê Inferido pela AI
);
```


#### **üìã Tabela 2: `incentives_metadata` (dados √∫nicos + AI)**

**Prop√≥sito**: Guardar dados originais do CSV + metadados de processamento AI.

**Por que esta tabela?** 
Para seguir a indica√ß√£o do enunciado onde a tabela `incentives` tem **10 campos**, mas o CSV tem **21 campos**, esta tabela serve para preservar todos os dados originais que podem ser relevantes para **matching futuro** (Fase 2), como:
- `all_data` (estrutura completa, calend√°rio, dota√ß√µes)
- `eligibility_criteria` (crit√©rios de elegibilidade)
- `incentive_program` (programa a que pertence)
- `status` (estado do incentivo)

```sql
CREATE TABLE incentives_metadata (
    metadata_id             UUID PRIMARY KEY,
    incentive_id            UUID UNIQUE REFERENCES incentives(incentive_id),
    raw_csv_data            JSON NOT NULL,      -- 13 campos: 9 √∫nicos + ai_description texto + 3 datas raw
    ai_processing_status    VARCHAR(50),        -- pending/processing/completed/failed
    ai_processing_date      TIMESTAMP,
    fields_completed_by_ai  JSON,              -- ['ai_description', 'dates', ...]
    ai_processing_error     TEXT,
    created_at              TIMESTAMP,
    updated_at              TIMESTAMP
);
```

**Detalhe dos 13 campos em `raw_csv_data`**:
- **9 campos √∫nicos** (n√£o existem em `incentives`): `all_data`, `form_info`, `eligibility_criteria`, `regions`, `sectors`, `cae_codes`, `objective`, `scraped_url`, `incentive_id_original`
- **1 campo para AI**: `ai_description` original do CSV em **texto puro** (usado pela AI para converter para JSON estruturado ou como contexto para gerar do zero)
- **3 campos de data/or√ßamento em formato raw** (antes de parsing): `submission_deadline`, `announcement_date`, `total_budget`

**Vantagens**:
- ‚úÖ **Respeita restri√ß√£o** do enunciado (10 campos em `incentives`)
- ‚úÖ **Sem duplica√ß√£o**: `raw_csv_data` guarda campos √∫nicos (n√£o repetidos em `incentives`)
- ‚úÖ **Rastreabilidade**: Sabemos exatamente quais campos foram completados por IA
- ‚úÖ **Controlo de processamento**: Flag `ai_processing_status` evita reprocessamento
- ‚úÖ **Dados para matching**: Campos como `eligibility_criteria` e `all_data` ser√£o usados na Fase 2
- ‚úÖ **Debugging**: `ai_processing_error` guarda erros para an√°lise

#### **üìã Tabela 3: `companies` (7 campos derivados)**

**Prop√≥sito**: Empresas do CSV original (4 campos dispon√≠veis).

```sql
CREATE TABLE companies (
    company_id               UUID PRIMARY KEY,
    company_name             VARCHAR(500) NOT NULL,
    cae_primary_label        VARCHAR(500),      -- Ex: "Software development"
    trade_description_native TEXT,              -- Descri√ß√£o em PT
    website                  VARCHAR(500),
    cae_primary_code         VARCHAR(50),       -- ‚≠ê Inferido pela AI
    company_size             VARCHAR(50),       -- ‚≠ê Inferido pela AI
    region                   VARCHAR(100),      -- ‚≠ê Inferido pela AI
    is_active                BOOLEAN DEFAULT TRUE
);
```

**Campos do CSV**: `company_name`, `cae_primary_label`, `trade_description_native`, `website`

**Campos inferidos pela AI**:
- `cae_primary_code`: C√≥digo CAE num√©rico inferido da descri√ß√£o textual
- `company_size`: Tamanho da empresa (micro/small/medium/large) inferido dos dados dispon√≠veis
- `region`: Regi√£o geogr√°fica inferida do nome e dados da empresa

---

### **Pipeline de Processamento**

#### **Fluxo Completo**

```
CSV ‚Üí Import ‚Üí Deterministic ‚Üí AI (fallback) ‚Üí Structured DB
```

#### **1Ô∏è‚É£ Fase 1: Import (sem custos)**

O `DataImporter` processa 2 CSVs:

**CSV de Incentivos** ‚Üí dividido em 2 tabelas

**CSV de Companies** ‚Üí importado diretamente para tabela `companies`

Ap√≥s o import, o sistema analisa cada incentivo e marca como `ai_processing_status = 'pending'` se estiver em falta:
- `ai_description` em JSON estruturado
- Datas (`publication_date`, `start_date`, `end_date`)
- Or√ßamento (`total_budget`)

**Custo desta fase: $0** (s√≥ parsing e base de dados)

#### **2Ô∏è‚É£ Fase 2: AI Processing (com custos otimizados)**

O `AIProcessor` processa apenas os incentivos marcados como `pending`, usando uma **abordagem h√≠brida** (determin√≠stico primeiro, AI s√≥ quando necess√°rio):

**Para cada incentivo pendente:**

1. **Extra√ß√£o de Datas** (h√≠brido):
   - **Determin√≠stico**: Procura em `all_data->calendario` por `dataPublicacao`, `dataInicio`, `dataFim`
   - **AI Fallback**: Se faltar alguma data, usa LLM para extrair do texto (prompt pequeno, ~300 tokens)
  
2. **Extra√ß√£o de Or√ßamento** (h√≠brido):
   - **Determin√≠stico**: Procura em `all_data->estrutura->dotacoes->valor`
   - **AI Fallback**: Se n√£o encontrar, usa LLM (prompt pequeno, ~200 tokens)

3. **Gera√ß√£o de `ai_description`** (sempre AI, mas otimizado):
   - **Convers√£o** (se campo `ai_description` no CSV tinha texto): Prompt curto pedindo apenas convers√£o de texto para JSON (800 tokens max)
   - **Gera√ß√£o do zero** (se `ai_description` no CSV estava vazio): Prompt completo analisando `all_data` + `eligibility_criteria` (1500 tokens max)
   - **Economia**: Convers√µes custam ~43% menos que gera√ß√µes

#### **3Ô∏è‚É£ Fase 3: Enriquecimento de Dados (infer√™ncia autom√°tica)**

Para maximizar a qualidade do matching, o sistema infere automaticamente campos em falta:

**Para Incentivos:**
- **CAE Code**: Inferido da descri√ß√£o do incentivo usando LLM para identificar setores espec√≠ficos

**Para Empresas:**
- **CAE Code**: Convers√£o de descri√ß√µes textuais (`cae_primary_label`) para c√≥digos num√©ricos usando LLM
- **Regi√£o**: Infer√™ncia da localiza√ß√£o baseada no nome da empresa e dados dispon√≠veis
- **Tamanho**: Classifica√ß√£o autom√°tica do porte da empresa (micro/small/medium/large)

**Estrat√©gias de Otimiza√ß√£o:**
- **Intelligent Fallback**: Mapeamento manual para casos comuns, LLM apenas quando necess√°rio
- **Intelligent Caching**: Reutiliza√ß√£o de respostas para inputs similares
- **Batch Processing**: Processamento em lotes para reduzir custos

---

### **Sistema H√≠brido: Quando usa Determin√≠stico vs AI**

| Campo | M√©todo Determin√≠stico | Quando usa AI | 
|-------|----------------------|---------------|
| **Datas** | Extrai de `all_data->calendario` (chaves fixas) | S√≥ se faltar ap√≥s extra√ß√£o | 
| **Or√ßamento** | Extrai de `all_data->estrutura->dotacoes` | S√≥ se faltar ap√≥s extra√ß√£o | 
| **ai_description** | ‚ùå N√£o aplic√°vel (precisa LLM para estruturar) | **Sempre**, mas com 2 prompts diferentes |
| **CAE Codes** | ‚ùå N√£o aplic√°vel (precisa LLM para inferir) | **Sempre** para incentivos e empresas |
| **Regi√£o** | ‚ùå N√£o aplic√°vel (precisa LLM para inferir) | **Sempre** para empresas |
| **Tamanho** | ‚ùå N√£o aplic√°vel (precisa LLM para inferir) | **Sempre** para empresas | 

**Vantagens do H√≠brido:**
- ‚úÖ **Gr√°tis quando poss√≠vel**
- ‚úÖ **Robusto**: Cobre casos onde dados estruturados est√£o incompletos
- ‚úÖ **Previs√≠vel**: Determin√≠stico d√° sempre o mesmo resultado

---

### **6 Otimiza√ß√µes de Custo Implementadas**

#### **1Ô∏è‚É£ Flag de Processamento (`ai_processing_status`)**

A **otimiza√ß√£o mais fundamental**: Cada incentivo tem um status na tabela `incentives_metadata`:
- `pending`: Precisa ser processado
- `completed`: J√° foi processado com sucesso ‚Üí **nunca reprocessa** (**custo = $0**)
- `failed`: Falhou (pode ser reprocessado manualmente)

#### **2Ô∏è‚É£ Prompts Adaptados**

O sistema **detecta automaticamente** se o CSV j√° tinha texto em `ai_description`:
- **Se tinha texto**: Usa prompt curto s√≥ para converter texto‚ÜíJSON (800 tokens m√°x)
- **Se estava vazio**: Usa prompt completo para gerar do zero (1500 tokens m√°x)

**Economia**: Convers√µes custam ~43% menos que gera√ß√µes

#### **3Ô∏è‚É£ Limites de Tokens Calibrados**

Cada opera√ß√£o tem um limite `max_tokens` ajustado ao m√≠nimo necess√°rio (com margem de seguran√ßa):
- `ai_description` (convers√£o): 800 tokens
- `ai_description` (gera√ß√£o): 1500 tokens
- Extra√ß√£o de datas: 300 tokens (s√≥ 3 datas em JSON)
- Extra√ß√£o de or√ßamento: 200 tokens (s√≥ 1 n√∫mero)

#### **4Ô∏è‚É£ Memory Cache**

Antes de chamar a API OpenAI, o sistema calcula um **hash MD5 do prompt completo**:
- **Cache HIT**: Se o prompt j√° foi usado antes nesta sess√£o, retorna o resultado guardado em mem√≥ria (**custo = $0**)
- **Cache MISS**: Se √© novo, chama a API e guarda o resultado no cache

**Caracter√≠sticas**:
- **100% preciso**: S√≥ reutiliza se o prompt for **exatamente** igual (hash MD5)
- **N√£o expira**: Cache dura toda a sess√£o de processamento
- **Transparente**: Aparece no cost tracker como "Cache HIT" ($0)

**Quando ajuda**: Datasets com incentivos duplicados/similares



#### **5Ô∏è‚É£ Enriquecimento Inteligente de Dados**

O sistema infere automaticamente campos em falta usando estrat√©gias otimizadas:

**Intelligent Fallback**: Mapeamento manual para casos comuns (ex: "Software development" ‚Üí CAE 62010)
**Intelligent Caching**: Reutiliza√ß√£o de respostas para inputs similares
**Batch Processing**: Processamento em lotes para reduzir custos de API

**Impacto**: Campos como CAE codes, regi√£o e tamanho s√£o essenciais para matching de qualidade, mas n√£o est√£o nos CSVs originais. O sistema os infere automaticamente com custos m√≠nimos.

---

### **Cost Tracking em Tempo Real**

O sistema implementa **tracking completo de custos** para garantir transpar√™ncia e controlo do or√ßamento.



#### **üìä O que √© tracked**

**N√≠vel de detalhe**: Cada chamada √† API OpenAI √© gravada na base de dados com:
- Tipo de opera√ß√£o (`ai_description_convert`, `extract_dates`, `extract_budget`)
- Modelo usado 
- Tokens consumidos (input, output, total)
- Custo calculado ($0.15/M input, $0.60/M output para gpt-4o-mini)
- Se foi cache HIT ($0) ou MISS (custo real)
- Sucesso/erro

**Visualiza√ß√£o em tempo real**: Durante o processamento, o terminal mostra:
- **Por incentivo**: Custo de cada opera√ß√£o (descri√ß√£o, datas, or√ßamento)
- **Acumulado**: Total gasto at√© agora
- **Resumo final**: Total de chamadas, cache hits/misses, custo m√©dio por incentivo




---

## üéØ FASE 2: Sistema de Matching Inteligente

### **Objetivo da Fase**

Implementar um sistema h√≠brido que identifica automaticamente as 5 empresas mais adequadas para cada incentivo, combinando busca sem√¢ntica, an√°lise determin√≠stica e intelig√™ncia artificial para maximizar precis√£o e minimizar custos.

---

### **Arquitetura do Sistema: Pipeline de 3 Fases**

O sistema implementa um **pipeline h√≠brido de 3 fases** que combina embeddings sem√¢nticos, scoring determin√≠stico e refinamento por LLM:

```
TODAS AS EMPRESAS
‚îÇ
‚îú‚îÄ FASE 1: VECTOR SEARCH (Embeddings Sem√¢nticos) üß†
‚îÇ   ‚îú‚îÄ Gera embeddings para incentivo e empresas
‚îÇ   ‚îú‚îÄ Busca por similaridade coseno
‚îÇ   ‚îú‚îÄ Seleciona Top 50 candidatas sem√¢nticas
‚îÇ   ‚îî‚îÄ Custo: ~$0.00002 por embedding (text-embedding-3-small)
‚îÇ
‚îú‚îÄ FASE 2: UNIFIED SCORER (Determin√≠stico) üìä
‚îÇ   ‚îú‚îÄ Analisa CAE codes, setores, regi√£o, tamanho
‚îÇ   ‚îú‚îÄ Atribui scores positivos/negativos
‚îÇ   ‚îú‚îÄ Ordena por relev√¢ncia
‚îÇ   ‚îî‚îÄ Seleciona Top 15 candidatas
‚îÇ
‚îî‚îÄ FASE 3: LLM REFINEMENT (Intelig√™ncia Artificial) ü§ñ
    ‚îú‚îÄ Recebe Top 15 candidatas + crit√©rios do incentivo
    ‚îú‚îÄ An√°lise contextual das nuances
    ‚îú‚îÄ Seleciona as 5 melhores com justifica√ß√µes detalhadas
    ‚îú‚îÄ Valida factualmente as raz√µes
    ‚îî‚îÄ Retorna ranking final otimizado

RESULTADO: Top 5 empresas mais adequadas ordenadas por match_score
```

**Vantagens do pipeline de 3 fases:**
- ‚úÖ **Busca sem√¢ntica**: Descobre matches n√£o √≥bvios baseados em significado
- ‚úÖ **Scoring determin√≠stico**: Mant√©m precis√£o com crit√©rios espec√≠ficos
- ‚úÖ **Refinamento LLM**: An√°lise contextual para qualidade superior
- ‚úÖ **Custo otimizado**: Redu√ß√£o de ~70% em custos LLM vs abordagem tradicional

---

### **Fase 1: Vector Search com Embeddings Sem√¢nticos**



O sistema usa **OpenAI text-embedding-3-small**

#### **Busca por Similaridade**

**Similaridade Coseno:**
- Calcula dist√¢ncia entre embeddings de incentivo e empresa
- Score de 0.0 (sem similaridade) a 1.0 (id√™ntico)
- Retorna Top 50 empresas mais similares

**Threshold m√≠nimo:** 0.2 (Similaridade m√≠nima aceit√°vel) 

#### **Vantagens dos Embeddings**

‚úÖ **Descoberta n√£o √≥bvia**: Encontra matches que filtros exatos perdem
‚úÖ **Compreens√£o sem√¢ntica**: Entende sin√≥nimos e varia√ß√µes lingu√≠sticas
‚úÖ **Redu√ß√£o de custos**: Filtra de milhares para 50 candidatas antes do LLM
‚úÖ **Cache inteligente**: Reutiliza embeddings calculados anteriormente
‚úÖ **Escalabilidade**: Funciona com milh√µes de empresas (otimizado com ChromaDB)

#### **Otimiza√ß√µes Implementadas**

- **Memory Cache**: Evita recalcular embeddings id√™nticos
- **Similaridade Coseno**: C√°lculo eficiente usando NumPy
- **Batch Processing**: Processa m√∫ltiplas empresas de uma vez
- **Vector Database**: Armazena embeddings em ChromaDB para busca r√°pida

---

### **Fase 2: Unified Scorer (An√°lise Determin√≠stica)**

#### **Sistema de Pontua√ß√£o Unificado**

O sistema substitui filtros bin√°rios por um **sistema de pontua√ß√£o cont√≠nuo** que avalia m√∫ltiplos crit√©rios:

**Crit√©rios Positivos:**
- **CAE Code Match**: Pontua√ß√£o alta para c√≥digos CAE exatos ou relacionados
- **Setor Match**: Alinhamento entre atividade da empresa e setores eleg√≠veis
- **Regi√£o Match**: Compatibilidade geogr√°fica com regi√µes eleg√≠veis
- **Tamanho Match**: Adequa√ß√£o do tamanho da empresa aos requisitos


---

### **Fase 3: LLM Refinement - Escolha Final**

#### **Como o LLM Escolhe as 5 Melhores**

O LLM analisa as 15 candidatas e retorna apenas as 5 melhores (com llm_score). Depois o sistema calcula o total_score combinando llm_score + unified_score + semantic_similarity e reordena por esse total_score (podendo alterar a ordem final).

Quando LLM recebe as 15 candidatas:

1. **Avalia Contextualmente**: Analisa n√£o apenas dados estruturados, mas tamb√©m contexto e nuances
2. **Aplica Crit√©rios Inteligentes**: 
   - Verifica correspond√™ncia de CAE codes eleg√≠veis
   - Avalia alinhamento de setor e atividade
   - Considera requisitos espec√≠ficos (tamanho, regi√£o, tipo de financiamento)
3. **Seleciona Top 5**: Escolhe as 5 empresas mais adequadas entre as 15 candidatas
4. **Gera Justifica√ß√µes**: Explica porqu√™ cada empresa √© adequada

#### **Sistema de An√°lise Batch**

**Uma √∫nica chamada LLM** processa todas as 15 candidatas simultaneamente:

```python
# O LLM recebe todas as 15 empresas e crit√©rios do incentivo
# Em UMA s√≥ chamada API, analisa todas e retorna top 5

Input:
- Incentivo: "Apoio √† digitaliza√ß√£o de PMEs"
- Candidatas: 15 empresas (j√° filtradas por Vector Search + Unified Scoring)
- Tarefa: Escolher top 5 com maior fit

Output:
- Top 5 empresas
- Raz√µes detalhadas para cada escolha
```

**Por que 15 candidatas?**
- D√° escolha real ao LLM (n√£o apenas valida√ß√£o)
- Permite compara√ß√£o direta entre empresas
- Mant√©m contexto suficiente para an√°lise inteligente
- Otimiza custos (1 chamada vs 15 chamadas individuais)

#### **Otimiza√ß√µes de Custo**

**Batch Processing:**
- Uma √∫nica chamada API por incentivo (vs m√∫ltiplas chamadas individuais)
- Processamento de 15 empresas simultaneamente
- Redu√ß√£o de custos vs an√°lise individual

**Prompt Engineering:**
- Apenas informa√ß√£o essencial (t√≠tulo, setores, CAE codes, requisitos)
- Exclus√£o de campos redundantes
- Estrutura otimizada para respostas JSON consistentes

**Configura√ß√£o Otimizada:**
- `max_tokens=2000`: Suficiente para respostas completas sem truncamento
- An√°lise contextual sem custos desnecess√°rios

#### **Valida√ß√£o e Corre√ß√£o Autom√°tica**

O sistema implementa **valida√ß√£o p√≥s-LLM** que:
- Verifica factualmente as alega√ß√µes do LLM (ex: elegibilidade de CAE codes)
- Corrige scores quando detecta informa√ß√µes incorretas
- Ajusta raz√µes para refletir a realidade dos dados
- Garante que rankings finais s√£o baseados em factos



#### **M√©tricas de Qualidade**

- **Scores Positivos**: Empresas com boa correspond√™ncia
- **Valida√ß√£o Autom√°tica**: Verifica√ß√£o de consist√™ncia dos resultados
- **Ranking Ordenado**: Empresas ordenadas por relev√¢ncia decrescente

---

### **Output e Resultados - Depois de todas as fases conclu√≠das**

#### **Estrutura de Resposta do Hybrid Matching**

Para cada incentivo, o sistema retorna uma **lista** com as top 5 empresas:

```json
[
  {
    "company_name": "Empresa A",
    "company_size": "medium",
    "region": "Lisboa",
    "cae_primary_code": ["62010", "62020"],
    
    // Scores combinados
    "semantic_similarity": 0.85,    // Similaridade sem√¢ntica (0.0-1.0)
    "unified_score": 150,            // Score determin√≠stico (pontos)
    "llm_score": 0.92,              // Score do LLM (0.0-1.0)
    "match_score": 0.89,            // Total score combinado
    
    // Raz√µes detalhadas
    "semantic_reasons": ["Similaridade sem√¢ntica: 0.850"],
    "unified_reasons": ["CAE code match", "Setor compat√≠vel"],
    "llm_reasons": ["Empresa desenvolve software para PMEs"],
    
    // Posi√ß√£o
    "ranking_position": 1
  }
  // ... at√© 5 empresas
]
```

#### **Match Score**

O `match_score` final combina 3 scores com pesos espec√≠ficos:

```python
total_score = (
    semantic_similarity √ó 0.3 +        # 30% - Busca sem√¢ntica
    normalized(unified_score) √ó 0.4 +  # 40% - Score determin√≠stico  
    llm_score √ó 0.3                    # 30% - An√°lise LLM
)

# Onde normalized = min(unified_score / 200.0, 1.0)


```

*

## ü§ñ **FASE 3: Chatbot de Incentivos**

### **Sistema Completo Implementado**

O chatbot permite aos utilizadores interagir naturalmente com o sistema atrav√©s de uma interface web moderna, fornecendo respostas inteligentes e contextualizadas sobre incentivos, empresas e correspond√™ncias.

### **Funcionalidades do Chatbot**

**Tipos de Consultas Suportadas:**
- ‚úÖ **Incentivos**: Listar, pesquisar e detalhar incentivos dispon√≠veis
- ‚úÖ **Empresas**: Explorar empresas por setor, regi√£o ou tipo
- ‚úÖ **Correspond√™ncias**: Obter top 5 matches para cada incentivo
- ‚úÖ **Estat√≠sticas**: An√°lise agregada (or√ßamentos, contagens, m√©dias)
- ‚úÖ **Consultas Contextuais**: Respostas inteligentes mantendo contexto da conversa

**Caracter√≠sticas Principais:**
- Interface web moderna integrada no container
- Respostas em portugu√™s natural e fluido
- Mant√©m mem√≥ria da conversa (contexto de sess√£o)
- Gera√ß√£o inteligente de respostas usando RAG (Retrieval-Augmented Generation)
- Cache autom√°tico para reduzir custos

---

### **Arquitetura do Chatbot**

O chatbot implementa uma **arquitetura de 3 camadas** para otimizar custos e qualidade:

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  1. Query Router Inteligente            ‚îÇ
‚îÇ     ‚Ä¢ Analisa inten√ß√£o da mensagem      ‚îÇ
‚îÇ     ‚Ä¢ Extrai entidades (UUIDs, setores) ‚îÇ
‚îÇ     ‚Ä¢ Roteia para handler apropriado    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  2. Database Queries Especializados     ‚îÇ
‚îÇ     ‚Ä¢ Consultas diretas √† BD            ‚îÇ
‚îÇ     ‚Ä¢ Filtros otimizados (SQLAlchemy)   ‚îÇ
‚îÇ     ‚Ä¢ Retorna dados estruturados        ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
             ‚îÇ
             ‚ñº
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  3. LLM Generation (Opcional)           ‚îÇ
‚îÇ     ‚Ä¢ Apenas quando necess√°rio          ‚îÇ
‚îÇ     ‚Ä¢ Contexto otimizado (<500 tokens) ‚îÇ
‚îÇ     ‚Ä¢ Respostas naturais em portugu√™s    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

**Otimiza√ß√µes:**
- **Zero chamadas LLM** para queries simples (listas, contagens)
- **Cache inteligente** para prompts similares
- **Batch processing** para m√∫ltiplas entidades

---

### **Query Router: An√°lise Inteligente**

O sistema implementa um **Query Router** que analisa automaticamente a inten√ß√£o da mensagem:

**Tipos de Intent Suportados:**
- `incentive_query`: Consultas sobre incentivos
- `company_query`: Consultas sobre empresas
- `match_query`: An√°lise de correspond√™ncias
- `analytics_query`: Estat√≠sticas e agrega√ß√µes
- `specific_query`: Detalhes por ID espec√≠fico

**Extra√ß√£o de Entidades:**
- **UUIDs**: IDs de incentivos ou empresas
- **Setores**: Setor/atividade mencionado
- **Regi√µes**: Localiza√ß√£o geogr√°fica
- **N√∫meros**: Or√ßamentos, contagens, datas

---

### **Como Usar o Chatbot**

#### **Setup Inicial**

```bash
# Setup padr√£o (recomendado para demonstrar): 20 incentivos + 1000 empresas
make setup-evaluator

# Setup r√°pido (10+100 empresas, ~3-5 min)
make setup-evaluator-quick

# Setup customizado
make setup-evaluator-custom NUM_INC=30 NUM_COMP=500
```

#### **Acesso ao Sistema**

Depois do setup, acede √†s seguintes interfaces:

**Interface Web (Chatbot)**:
```
http://localhost:8000/web/
```

**API REST (Swagger)**:
```
http://localhost:8000/docs
```

**Chatbot API**:
```
http://localhost:8000/chatbot/
```

#### **Comandos de Teste**

```bash
# Testar chatbot
make test-chatbot

# Teste completo do sistema
make test-complete

# Ver logs
make logs

# Ver custos de AI
make show-costs
```

---

### **Exemplos de Perguntas**

**Consultas sobre Incentivos:**
- "Quais incentivos existem para empresas de software?"
- "Mostra-me incentivos para o setor tur√≠stico"
- "Quantos incentivos temos na base de dados?"
- "Qual o or√ßamento total dispon√≠vel?"

**Consultas sobre Empresas:**
- "Mostra-me empresas do setor tecnol√≥gico"
- "Quais empresas existem na regi√£o de Lisboa?"
- "Empresas de agricultura"

**An√°lise de Correspond√™ncias:**
- "Que empresas s√£o adequadas para o incentivo de infraestrutura portu√°ria?"
- "Mostra-me os matches do incentivo X"
- "Empresas adequadas para o incentivo de cuidados de sa√∫de"

**Estat√≠sticas:**
- "Quantos incentivos e empresas temos?"
- "Qual o or√ßamento total?"
- "M√©dia de or√ßamento por incentivo?"

---

# üß™ Suite de Testes - Resumo Final


### **Estrutura:**
```
backend/tests/
‚îú‚îÄ‚îÄ __init__.py
‚îú‚îÄ‚îÄ conftest.py              # Fixtures e configura√ß√£o
‚îú‚îÄ‚îÄ test_api_basic.py        # 12 testes b√°sicos
‚îî‚îÄ‚îÄ README.md               # Documenta√ß√£o t√©cnica
```


#### API Basic (6 testes)
- ‚úÖ `test_api_health` - Health check
- ‚úÖ `test_api_root` - Root endpoint
- ‚úÖ `test_chatbot_health` - Chatbot health
- ‚úÖ `test_get_chatbot_help` - Help endpoint
- ‚úÖ `test_check_data_files` - Data files status
- ‚úÖ `test_get_import_status` - Import status

#### Input Validation (6 testes)
- ‚úÖ `test_invalid_pagination_incentives` - Pagina√ß√£o inv√°lida
- ‚úÖ `test_invalid_pagination_companies` - Pagina√ß√£o inv√°lida
- ‚úÖ `test_missing_required_parameter` - Par√¢metro obrigat√≥rio
- ‚úÖ `test_list_companies_search_no_results` - Busca sem resultados
- ‚úÖ `test_list_incentives_returns_valid_structure` - Estrutura valida
- ‚úÖ `test_list_companies_returns_valid_structure` - Estrutura valida

## üöÄ **Como Executar**

### **Todos os Testes:**
```bash
make test
```

### **Apenas Testes B√°sicos:**
```bash
docker compose exec api bash -c "cd /app && pytest tests -v"
```

### **Com Coverage:**
```bash
make test-cov
```


## üéØ **O Que √â Testado**

- ‚úÖ Health checks (API e chatbot)
- ‚úÖ Root endpoints
- ‚úÖ Help e documenta√ß√£o
- ‚úÖ Status de ficheiros
- ‚úÖ Valida√ß√£o de input (pagination, par√¢metros)
- ‚úÖ Estrutura de respostas da API
- ‚úÖ Buscas sem resultados
- ‚úÖ Valida√ß√£o de erros 422

## üîí **Seguran√ßa**

- ‚úÖ **Totalmente isolado** - SQLite in-memory
- ‚úÖ **Sem custos** - Nenhuma chamada OpenAI real
- ‚úÖ **R√°pido** - 0.21s para todos os testes
- ‚úÖ **N√£o afeta sistema** - BD de produ√ß√£o separada

## üìö **Documenta√ß√£o**

- `backend/tests/README.md` - Documenta√ß√£o t√©cnica



---
